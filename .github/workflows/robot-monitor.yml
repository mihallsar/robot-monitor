name: Robot Catalog Monitor

on:
  schedule:
    - cron: '0 */12 * * *'  # –ö–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ (–¥–≤–∞–∂–¥—ã –≤ –¥–µ–Ω—å)
  workflow_dispatch:

jobs:
  update-robots:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: ü§ñ Update Robot Catalog
        env:
          COMPOSIO_KEY: ${{ secrets.COMPOSIO_API_KEY }}
          ROBOT_KEY: ${{ secrets.ROBOT_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import requests
          import json

          print("üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö —Ä–æ–±–æ—Ç–æ–≤...")

          composio_key = os.environ.get('COMPOSIO_KEY')
          robot_key = os.environ.get('ROBOT_KEY')

          if not composio_key or not robot_key:
              print("‚ùå API –∫–ª—é—á–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
              exit(1)

          print("‚úÖ API –∫–ª—é—á–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")

          # –í—ã–∑—ã–≤–∞–µ–º recipe
          url = "https://backend.composio.dev/api/v3/actions/execute"

          payload = {
              "appName": "rube",
              "actionName": "EXECUTE_RECIPE",
              "input": {
                  "recipe_id": "rcp_5ajueyVK76BF",
                  "input_data": {
                      "api_url": "https://robototehnika.vercel.app/api/robots",
                      "api_key": robot_key,
                      "search_mode": "news",
                      "max_robots_per_manufacturer": "10"
                  }
              }
          }

          headers = {
              "Content-Type": "application/json",
              "x-api-key": composio_key
          }

          print(f"\nüîÑ –í—ã–∑—ã–≤–∞–µ–º Composio Recipe API...")

          try:
              response = requests.post(
                  url,
                  headers=headers,
                  json=payload,
                  timeout=300
              )

              print(f"üìä HTTP –°—Ç–∞—Ç—É—Å: {response.status_code}")

              if response.status_code in [200, 201, 202]:
                  print("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç!")
                  try:
                      data = response.json()
                      print(f"üìÑ –û—Ç–≤–µ—Ç: {json.dumps(data, indent=2)[:500]}")

                      # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                      if 'data' in data:
                          stats = data.get('data', {})
                          if 'data' in stats:
                              stats = stats['data']
                          robots = stats.get('robots_published', stats.get('published', 'N/A'))
                          processed = stats.get('processed', 'N/A')
                          print(f"ü§ñ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–æ–±–æ—Ç–æ–≤: {processed}")
                          print(f"‚ú® –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {robots}")
                  except Exception as e:
                      print(f"üìÑ –û—Ç–≤–µ—Ç: {response.text[:500]}")
                      print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")

                  print("üéâ –ö–∞—Ç–∞–ª–æ–≥ —Ä–æ–±–æ—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!")
              else:
                  print(f"‚ö†Ô∏è –ö–æ–¥ {response.status_code}: {response.text[:300]}")
                  exit(1)

          except Exception as e:
              print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
              exit(1)

          print("\n‚ú® –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!")

          EOF
