name: Robot Catalog Monitor

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  update-robots:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests

      - name: ðŸ¤– Update Robot Catalog
        env:
          COMPOSIO_KEY: ${{ secrets.COMPOSIO_API_KEY }}
          ROBOT_KEY: ${{ secrets.ROBOT_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import requests
          import json

          print("ðŸ” ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¿Ð¾Ð¸ÑÐº Ð½Ð¾Ð²Ñ‹Ñ… Ñ€Ð¾Ð±Ð¾Ñ‚Ð¾Ð²...")

          composio_key = os.environ.get('COMPOSIO_KEY')
          robot_key = os.environ.get('ROBOT_KEY')

          if not composio_key or not robot_key:
              print("âŒ API ÐºÐ»ÑŽÑ‡Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹!")
              exit(1)

          print("âœ… API ÐºÐ»ÑŽÑ‡Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹")

          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ endpoints
          endpoints = [
              {
                  "url": "https://backend.composio.dev/api/v3/actions/execute",
                  "payload": {
                      "appName": "rube",
                      "actionName": "EXECUTE_RECIPE",
                      "input": {
                          "recipe_id": "rcp_5ajueyVK76BF",
                          "input_data": {
                              "api_url": "https://robototehnika.vercel.app/api/robots",
                              "api_key": robot_key,
                              "search_mode": "news",
                              "max_robots_per_manufacturer": "10"
                          }
                      }
                  }
              },
              {
          ]

          headers = {
              "Content-Type": "application/json",
              "x-api-key": composio_key
          }

          success = False

          for i, endpoint in enumerate(endpoints, 1):
              print(f"\nðŸ”„ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° {i}: {endpoint['url']}")
              
              try:
                  response = requests.post(
                      endpoint['url'],
                      headers=headers,
                      json=endpoint['payload'],
                      timeout=300
                  )
                  
                  print(f"ðŸ“Š HTTP Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: {response.status_code}")
                  
                  if response.status_code in [200, 201, 202]:
                      print("âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚!")
                      try:
                          data = response.json()
                          print(f"ðŸ“„ ÐžÑ‚Ð²ÐµÑ‚: {json.dumps(data, indent=2)[:500]}")
                          
                          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
                          if 'data' in data:
                              stats = data.get('data', {})
                              robots = stats.get('robots_published', 'N/A')
                              print(f"ðŸ¤– Ð Ð¾Ð±Ð¾Ñ‚Ð¾Ð² Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾: {robots}")
                      except:
                          print(f"ðŸ“„ ÐžÑ‚Ð²ÐµÑ‚: {response.text[:500]}")
                      
                      print("ðŸŽ‰ ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¾Ð² ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½!")
                      success = True
                      break
                  else:
                      print(f"âš ï¸ ÐšÐ¾Ð´ {response.status_code}: {response.text[:200]}")
                      
              except Exception as e:
                  print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {str(e)}")

          if not success:
              print("\nâŒ Ð’ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¸ÑÑŒ")
              print("ðŸ’¡ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ API ÐºÐ»ÑŽÑ‡ÐµÐ¹")
              exit(1)
          else:
              print("\nâœ¨ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!")

          EOF
