name: Robot Catalog Monitor

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  update-robots:
    runs-on: ubuntu-latest
    
    steps:
      - name: ü§ñ Update Robot Catalog
        env:
          COMPOSIO_KEY: ${{ secrets.COMPOSIO_API_KEY }}
          ROBOT_KEY: ${{ secrets.ROBOT_API_KEY }}
        run: |
          echo "üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö —Ä–æ–±–æ—Ç–æ–≤..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–∏
          if [ -z "$COMPOSIO_KEY" ]; then
            echo "‚ùå COMPOSIO_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          fi
          
          if [ -z "$ROBOT_KEY" ]; then
            echo "‚ùå ROBOT_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          fi
          
          echo "‚úÖ API –∫–ª—é—á–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π V3 endpoint
          echo "üöÄ –í—ã–∑—ã–≤–∞–µ–º Recipe —á–µ—Ä–µ–∑ API v3..."
          
          response=$(curl -X POST \
            "https://backend.composio.dev/api/v3/actions/execute" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $COMPOSIO_KEY" \
            -d "{
              \"appName\": \"rube\",
              \"actionName\": \"EXECUTE_RECIPE\",
              \"input\": {
                \"recipe_id\": \"rcp_5ajueyVK76BF\",
                \"input_data\": {
                  \"api_url\": \"https://robototehnika.vercel.app/api/robots\",
                  \"api_key\": \"$ROBOT_KEY\",
                  \"search_mode\": \"news\",
                  \"max_robots_per_manufacturer\": \"10\"
                }
              }
            }" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          body=$(echo "$response" | grep -v "HTTP_STATUS")
          
          echo "üìä HTTP –°—Ç–∞—Ç—É—Å: $http_code"
          echo "üìÑ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
          echo "$body" | head -c 500
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ] || [ "$http_code" = "202" ]; then
            echo ""
            echo "‚úÖ –ö–∞—Ç–∞–ª–æ–≥ —Ä–æ–±–æ—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            robots_count=$(echo "$body" | grep -o '"robots_published":[0-9]*' | cut -d':' -f2)
            if [ ! -z "$robots_count" ]; then
              echo "ü§ñ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–æ–±–æ—Ç–æ–≤: $robots_count"
            fi
            
            echo "üéâ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
            exit 0
          else
            echo ""
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞"
            echo "üí° HTTP –∫–æ–¥: $http_code"
            exit 1
          fi

      - name: üéâ Success
        if: success()
        run: echo "‚ú® –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!
